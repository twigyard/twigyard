#!/usr/bin/env php
<?php

use Symfony\Component\Console\Application;
use Symfony\Component\Console\Input\ArgvInput;

date_default_timezone_set('UTC');
set_time_limit(0);

(@include_once __DIR__ . '/../vendor/autoload.php') || @include_once __DIR__ . '/../../../autoload.php';

function initYamlLinter(Application $application) {
    $application->add(new Symfony\Component\Yaml\Command\LintCommand());
}

function initTwigLinter(Application $application) {
    $twigLintCommand = new Symfony\Bridge\Twig\Command\LintCommand();

    $twigEnvironment = new \Twig_Environment(new \Twig_Loader_Filesystem());

    $twigEnvironment->addExtension(new Twig_Extensions_Extension_Text());
    $twigEnvironment->addExtension(new Twig_Extensions_Extension_I18n());
    $twigEnvironment->addExtension(new Twig_Extensions_Extension_Intl());
    $twigEnvironment->addExtension(new Twig_Extensions_Extension_Date());
    $translator = new Symfony\Component\Translation\Translator('en_US');
    $twigEnvironment->addExtension(new Symfony\Bridge\Twig\Extension\TranslationExtension($translator));

    $twigEnvironment->addFunction(new Twig_SimpleFunction('asset', function () {}));
    $twigEnvironment->addFunction(new Twig_SimpleFunction('image', function () {}));
    $twigEnvironment->addFunction(new Twig_SimpleFunction('path', function () {}));

    $twigLintCommand->setTwigEnvironment($twigEnvironment);
    $application->add($twigLintCommand);
}

$application = new Application('TwigYard', '0.1.0');
initYamlLinter($application);
initTwigLinter($application);
$application->setAutoExit(false);

$argv = $_SERVER['argv'];
$argc = $_SERVER['argc'];

if ($argc === 2) {
    $application->run(new ArgvInput(['', 'lint:yaml', 'sites/' . $argv[1]]));
    $application->run(new ArgvInput(['', 'lint:twig', 'sites/' . $argv[1]]));
} elseif ($argc === 1) {
    $application->run(new ArgvInput(['', 'lint:yaml', 'sites']));
    $application->run(new ArgvInput(['', 'lint:twig', 'sites']));
} else {
    $output = new \Symfony\Component\Console\Output\ConsoleOutput();
    $output->write(<<<EOF
The <info>lintsite</info> command lints a twig templates and yaml configuration files.

You can validate the syntax of contents of the site

  <info>lintsite sitename</info>

Or the syntax of the whole site's directory:

  <info>lintsite</info>

EOF
    );
}
